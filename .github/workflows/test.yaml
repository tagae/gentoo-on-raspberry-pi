name: test

on:
  push:
    branches:
      - master

jobs:

  linux:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Update packages
      run: sudo apt-get update

    - name: Setup aarch64 emulation
      run: sudo apt-get install -y qemu-user-binfmt

    - name: Provision builder
      run: sudo ./builder ./provision

    - name: Build image
      run: sudo ./builder env PASSWORD=test-S3cr3t ./package gentoo.virt.img

    - name: Test image
      run: sudo ./builder ./test gentoo.virt.img

    - name: Test console
      run: sudo ./builder env PASSWORD=test-S3cr3t ./test-console gentoo.virt.img
